<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <meta name="og:title" content="Comment passer au monorepo avec Lerna" />
    <meta name="og:url" content="http://otso.fr/2020-05-08-passez-en-monorepo-avec-lerna.html" />
    <meta name="og:site_name" content="Blob Trotter" />

    
    <meta name="description" content="Suivez-moi pas √† pas dans la d√©couverte du monde fantastique des monorepos" />
    <meta name="og:description" content="Suivez-moi pas √† pas dans la d√©couverte du monde fantastique des monorepos" />
     
    <meta name="robots" content="index, follow" />
     
    <meta name="og:type" content="article" />
      
    <meta name="twitter:card" content="summary" />
     
    <meta name="twitter:site" content="@adriantombu" />
     
    <meta name="twitter:creator" content="@adriantombu" />
    

    <title>Comment passer au monorepo avec Lerna - Blob Trotter</title>

    <link rel="icon" href="./favicon.png" />
    <link href="./style.css" rel="stylesheet" type="text/css" />
    <link rel="canonical" href="http://otso.fr/2020-05-08-passez-en-monorepo-avec-lerna.html" />
  </head>

  <body>
    <header>
      <nav>
        <a href="https://otso.fr">Accueil</a> &bull;
        <a href="https://otso.fr/index-en.html">In English</a> &bull; Blog
        &bull;
        <a href="https://otso.fr/conditions-generales-de-vente.html">CGV</a>
        &bull;
        <a href="https://otso.fr/mentions-legales.html">Mentions l√©gales</a>
      </nav>
    </header>

    <article>
      <h1>Comment passer au monorepo avec Lerna</h1>

<p>Suivez-moi pas √† pas dans la d√©couverte du <strong>monde fantastique des monorepos</strong> !</p>

<p><img src="images/2020-05-08-passez-en-monorepo-avec-lerna/rainbow.gif" alt="Monorepos are magic" /></p>

<p>Tout est parti de mon envie de <strong>simplifier la maintenance</strong> de mes quelques modules NPM qui ont chacun un d√©p√¥t Git d√©di√©. Un des probl√®mes principaux que j&rsquo;ai rencontr√©s, c&rsquo;est que ces modules partagent beaucoup de d√©pendances communes, notamment dans les <code>devDependencies</code> (<em>Typescript, Prettier, Jest, Husky, &hellip;</em>) ou les fichiers de config (<em>.prettierc, tsconfig.json, jest.config.js</em>). Les maintenir √† jour un par un lors de la publication de patchs de s√©curit√© devient rapidement <strong>long et r√©p√©titif</strong>. D&rsquo;o√π l&rsquo;id√©e de passer au monorepo et g√©rer toutes ces d√©pendances communes √† un seul endroit √† la racine du d√©p√¥t.</p>

<p>Mais avant toutes choses, reprenons avec les bases.</p>

<h2>C&rsquo;est quoi un monorepo ?</h2>

<p>Rien de tel que <a href="https://en.wikipedia.org/wiki/Monorepo">l&rsquo;ami Wikipedia</a> pour en savoir plus :</p>

<blockquote>
<p>Dans les syst√®mes de gestion de versions, un monorepo (mot valise de l&rsquo;expression <code>monolithic repository</code>) est une strat√©gie de d√©veloppement software o√π le code de plusieurs projets diff√©rents est h√©berg√© dans le m√™me d√©p√¥t.</p>
</blockquote>

<h3>Les avantages</h3>

<ul>
<li><strong>La r√©utilisation du code est simplifi√©e</strong> : il est possible de cr√©er des librairies partag√©es directement incluses dans les projets sans devoir utiliser un gestionnaire de librairie</li>
<li>Les projets existant tous dans le m√™me d√©p√¥t, <strong>les d√©pendances sont g√©r√©es tr√®s simplement</strong>. L&rsquo;√©tape de build peut donc facilement √™tre optimis√©e car il n&rsquo;y a pas besoin de t√©l√©charger les d√©pendences √† de multiples reprises comme dans le multi-repo.</li>
<li>Il devient √©galement tr√®s simple de <strong>travailler sur plusieurs projets interd√©pendants en m√™me temps</strong> en faisant des <a href="http://adopteungit.fr/methodologie/2017/04/26/commits-atomiques-la-bonne-approche.html">commits atomiques</a> sans se perdre dans la gestion des d√©pendances</li>
<li>Le d√©veloppeur ayant acc√®s √† l&rsquo;enti√®ret√© d&rsquo;un projet, <strong>un refactoring global est possible</strong> tout en s&rsquo;assurant que le projet continue de fonctionner</li>
</ul>

<h3>Les inconv√©nients</h3>

<ul>
<li>Certains projets utilisent parfois un <strong>num√©ro de version global identique pour tous les projets</strong> du d√©p√¥t. Cela signifie que m√™me si certains n&rsquo;ont pas √©t√© modifi√©s, ils seront d√©ploy√©s avec un nouveau num√©ro de version, ce qui va √† l&rsquo;encontre du <a href="https://semver.org/lang/fr/">versionnement s√©mantique</a>.</li>
<li>Etant donn√© que tout le code est contenu dans un seul d√©p√¥t, il n&rsquo;est <strong>pas possible de donner √† un d√©veloppeur un acc√®s restreint</strong> √† un seul projet comme c&rsquo;est le cas du multi-repo, ce qui peut poser quelques probl√®mes de s√©curit√©.</li>
<li>Suivant les syst√®mes de versionnement, t√©l√©charger l&rsquo;enti√®ret√© du projet vous oblige √©galement √† <strong>utiliser plus d&rsquo;espace de stockage</strong> par rapport au syst√®me multi-repo o√π vous ne t√©l√©chargez que les projets sur lesquels vous travaillez.</li>
</ul>

<p>Maintenant que vous en savez plus sur le c√¥t√© th√©orique, il est temps de passer aux choses concr√®tes !</p>

<h2>Un monorepo en pratique</h2>

<p>Il existe diff√©rentes mani√®res de g√©rer un monorepo, et dans cet article je me contenterai d&rsquo;utiliser <a href="https://lerna.js.org/">Lerna</a> qui est d√©di√© aux <strong>monorepos de projets JavaScript</strong>. Il existe √©videmment d&rsquo;autres fa√ßons de g√©rer un mono repo : <a href="https://classic.yarnpkg.com/en/docs/workspaces/">Yarn worskpaces</a>, <a href="https://github.com/teambit/bit">Bit</a>, <a href="https://bazel.build/">Bazel</a> et <a href="https://github.com/korfuri/awesome-monorepo">bien d&rsquo;autres</a>&hellip;</p>

<h3>Initialiser son premier monorepo</h3>

<p>Avant toutes choses nous allons <strong>installer Lerna</strong> sur notre machine avec la commande suivate</p>

<pre><code>npm install --global lerna
</code></pre>

<p>Il est temps maintenant de <strong>cr√©er notre projet</strong> <code>packages</code> qui contiendra nos diff√©rents modules NPM. Le nom du dossier importe peu, j&rsquo;aurais pu utiliser <code>catlover</code> ou <code>unicorns</code>.</p>

<pre><code>git init packages &amp;&amp; cd packages
</code></pre>

<p>Une fois dans le dossier <code>packages</code> il est temps d&rsquo;<strong>initaliser Lerna</strong> en sp√©cifiant le tag <code>--independant</code> car je ne souhaite pas utiliser un num√©ro de version global identique pour tous mes projets, ceux-ci n&rsquo;√©tant pas vraiment li√©s entre eux (<em>au contraire de <a href="https://github.com/facebook/jest/blob/master/lerna.json">Jest</a> ou <a href="https://github.com/babel/babel/blob/master/lerna.json">Babel</a> qui utilisent cette m√©thode</em>).</p>

<pre><code>lerna init --independent
</code></pre>

<p>Cette commande va cr√©er la structure de dossier suivante :</p>

<pre><code>lerna.json
package.json
packages/
</code></pre>

<p>Comme vous pouvez vous en douter, le dossier <code>packages</code> contiendra vos diff√©rentes projets cr√©√©s dans leurs sous-dossiers respectifs.</p>

<blockquote>
<p>‚ö†Ô∏è Il est important de noter que Lerna utilise <code>npm</code> comme gestionnaire de d√©pendances par d√©faut. Si vous pr√©f√©rez utiliser <code>yarn</code> ajoutez simplement <code>&quot;npmClient&quot;: &quot;yarn&quot;,</code> dans votre fichier de configuration <code>lerna.json</code></p>
</blockquote>

<h3>Importer des projets existants</h3>

<p>C&rsquo;est bien beau tout √ßa, mais comment importer mes diff√©rents modules NPM d√©j√† existants ? Gr√¢ce √† la commande magique <code>lerna import</code>, pardi ! Mais avant toutes choses, et pour que cette commande puisse fonctionner correctement, il faut cr√©er notre tout premier commit.</p>

<pre><code>git add -A
git commit -m &quot;üéâ Initial commit&quot;
</code></pre>

<p>Il est d√©sormais temps d&rsquo;<strong>importer nos projets un par un</strong> avec la commande <code>import</code> de Lerna (<em>voir <a href="https://github.com/lerna/lerna/tree/master/commands/import#options">la documentation</a> pour plus d&rsquo;information sur les diff√©rents flags</em>), qui a l&rsquo;√©norme avantage de rapatrier √©galement tout l&rsquo;historique des commits afin que celui-ci ne soit pas perdu.</p>

<pre><code>lerna import &lt;dossier/du/module&gt; --flatten --preserve-commit
</code></pre>

<p>Et voici √† quoi ressemble l&rsquo;import r√©ussi de mon tr√®s c√©l√®bre (vraiment pas) <a href="https://www.npmjs.com/package/@adriantombu/vat-number">module de validation de num√©ro de TVA</a> :</p>

<p><img src="images/2020-05-08-passez-en-monorepo-avec-lerna/monorepo-lerna-import-project.png" alt="Import d&rsquo;un d√©p√¥t Git dans un monorepo Lerna" /></p>

<p>Ci-dessous la structure finale du repo Lerna une fois que tous mes projets ont √©t√© import√©s. Vous pouvez √©galement utiliser la commande <code>lerna list</code> pour <strong>lister tous les projets existants</strong> dans le d√©p√¥t.</p>

<pre><code>.git/
lerna.json
package.json
packages/
¬†¬†|__ ...
¬†¬†|__ siret-to-vat
¬†¬†|__ vat-number
</code></pre>

<p>Il est d√©sormais temps de <strong>nettoyer un peu tout ce qui est redondant</strong>, √† savoir les <code>devDependencies</code> et les fichiers de configuration des diff√©rents modules qui sont tous identiques, et les d√©placer √† la racine du projet ainsi que dans le <code>package.json</code> principal.</p>

<p>Une fois tous ces changements fait, on installe toutes les d√©pendances d&rsquo;un coup avec la commande</p>

<pre><code>lerna bootstrap
</code></pre>

<p>Pour vous donner une id√©e de la structure finale du projet, vous pouvez acc√©der au monorepo √† l&rsquo;adresse suivante : <a href="https://github.com/adriantombu/packages">https://github.com/adriantombu/packages</a></p>

<h3>D√©ployer ses modules sur NPM</h3>

<p>Avant toutes choses v√©rifiez bien que vos <strong>√©tapes de builds</strong> seront lanc√©es si vous en avez. De mon c√¥t√© j&rsquo;utilise dans le <code>package.json</code> global les commandes <code>prepare</code> pour compiler le TypeScript vers JavaScript et <code>prepublishOnly</code> pour lancer les tests.</p>

<p>Une fois ces modifications effectu√©es, il ne reste plus qu&rsquo;√† <strong>taguer les packages modifi√©s et les d√©ployer sur NPM</strong> avec les 2 commandes suivantes.</p>

<pre><code>lerna version
lerna publish from-package
</code></pre>

<p>Pour en savoir plus sur les diff√©rentes options de ces commandes, n&rsquo;h√©sitez pas √† jeter un oeil √† la doc de <a href="https://github.com/lerna/lerna/tree/master/commands/version">version</a> et <a href="https://github.com/lerna/lerna/tree/master/commands/publish">publish</a>.</p>

<blockquote>
<p>Il est possible de n&rsquo;utiliser que <code>lerna publish</code> sans option, qui lancera <code>lerna version</code> automatiquement, mais c&rsquo;est un comportement qui n&rsquo;existera plus dans la version 4 de Lerna, mieux vaut adopter cette pratique d√®s maintenant.</p>
</blockquote>

<h2>Conclusion</h2>

<p>L&rsquo;objectif premier de cette mise en pratique du monorepo √©tait pour moi de <strong>simplifier la gestion de mes quelques modules NPM</strong>. Il me reste encore √† g√©rer quelques am√©liorations, comme instaurer le <strong>d√©ploiement automatis√©</strong> via les Github Actions comme c&rsquo;√©tait le cas dans mes projets multi-repos.</p>

<p>J&rsquo;ai rencontr√© quelques probl√®mes lors de la mise en place de ce monorepo car la documentation de Lerna n&rsquo;est pas forc√©ment tr√®s bien faite. J&rsquo;ai donc du faire de nombreuses recherches et √©plucher beaucoup d&rsquo;articles sur le sujet pour enfin arriver √† un monorepo qui fonctionne comme je le souhaite.</p>

<p>L&rsquo;un dans l&rsquo;autre je trouve cet outil <strong>plut√¥t pratique dans le cas pr√©cis de mutualiser</strong> les <code>devDependencies</code> et les diff√©rents fichier de configuration. La gestion simplifi√©e de la modification de version des packages via <code>lerna version</code> est √©galement un gros plus, tout comme le <strong>d√©ploiement de plusieurs modules en une seule commande</strong>.</p>

<p>N&rsquo;h√©sitez pas √† <strong>discuter de cet article</strong> avec moi sur <a href="https://twitter.com/adriantombu">Twitter</a> ou <a href="https://www.linkedin.com/in/adriantombu/">Linkedin</a> si vous avez des astuces ou bonnes pratiques √† partager sur la gestion des monorepos !</p>

<p><img src="images/2020-05-08-passez-en-monorepo-avec-lerna/thank-you-for-watching.gif" alt="Thanks for watching" /></p>

    </article>

    <footer>
      <nav>
         
        <p>
          <a href="2019-12-26-top-10-erreurs-communes-projets-golang.html"
            >Les 10 erreurs les plus fr√©quentes que j'ai rencontr√©es sur des projets Go &gt;&gt;</a
          >
        </p>
        
      </nav>
    </footer>
  </body>
</html>
